# Fuzzing-deb-with-sanitizers
This repo contains all the files and scripts needed from **Step 2  - Soundness Issue Detection via Fuzz Testing** to **Step 4 - Soundness Issue Deduplication**.

## Installation
### Solution 1: Pull the docker image we prepared
```
docker pull ****************
```

### Solution 2: Manual installation
#### Dependencies
* [AFL++](https://github.com/AFLplusplus/AFLplusplus)
* [SymCC](https://github.com/eurecom-s3/symcc/tree/master)
* [Radamsa](https://gitlab.com/akihe/radamsa)
* [Clang-15](https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.7)

#### Build SymCC as a custom mutator of AFL++
Follow the instructions in [custom_mutators_symcc](https://github.com/AFLplusplus/AFLplusplus/tree/stable/custom_mutators/symcc)

## Repo Structure

```bash
├── blade                                # Directory for fuzzing debloated programs generated by Blade
│   ├── bzip2-1.0.5-argv-fuzz            # Directory for fuzzing the bzip2 program generated by Blade using argv-fuzz
│   │   ├── afl_auto_test.sh             # Script for automating AFL++ testing
│   │   ├── argv-fuzz-inl.h              # Header file required for argv-fuzz
│   │   ├── auto_verify.sh               # Script for automating "verification and deduplication"
│   │   ├── bins                         # Stores binaries generated during execution
│   │   ├── bzip2-1.0.5.c.origin.c       # Source code of original program
│   │   ├── bzip2-1.0.5.c.reduced.c      # Source code of debloated program
│   │   ├── compile.sh                   # Compilation script
│   │   ├── input                        # Input files for fuzz testing
│   │   │   ├── afl_seed                 # AFL++ fuzzing seed
│   │   │   └── radamsa_fuzzed           # Fuzzed inputs for Radamsa testing (only present in the corresponding chisel directory)
│   │   ├── result
│   │   │   ├── afl_result               # AFL++ test results
│   │   │   │   └── reduced              # AFL++ test results on the debloated program
│   │   │   │       ├── result_0         # Test results for seed_0 (each subfolder corresponds to results under 6 different sanitizers)
│   │   │   │       │   ├── asan         
│   │   │   │       │   ├── lsan
│   │   │   │       │   ├── msan
│   │   │   │       │   ├── nosan
│   │   │   │       │   ├── tsan
│   │   │   │       │   └── ubsan
│   │   │   │       ├── result_1         # Test results for seed_1 (same subdirectory structure as result_0)
│   │   │   │       └── ....... 
│   │   │   ├── radamsa_result           # Radamsa test results
│   │   │   │   ├── origin               # Results of each fuzz input on the original program
│   │   │   │   └── reduced              # Results of each fuzz input on the debloated program
│   │   │   └── symcc_result             # SymCC test results
│   │   │       └── reduced              # SymCC test results on the debloated program
│   │   │           ├── result_0         # Test results for seed_0 (only NOSAN result as sanitizers are not supported)
│   │   │           │   └── nosan
│   │   │           ├── result_1         # Test results for seed_1 (same subdirectory structure as result_0)
│   │   │           └── ......
│   │   ├── symcc_auto_test.sh           # Script for automating SymCC testing
│   │   ├── train_input_copy             # Copy of input cases used
│   │   ├── trash_clear.sh               # Script for cleaning up temporary files in the current directory
│   │   └── verify.sh                    # Script for validating and deduplicating the soundness issues
│   ├── bzip2-1.0.5-input-fuzz
│   ├── ......
│   └── uniq-8.16-input-fuzz
├── cov                                  # Directory for fuzzing debloated programs generated by Cov (subdirectory structure similar to blade)
└── ......                               # Other debloating tools

```

## How to fuzz
Take the fuzzing of `bzip2-1.0.5` program debloated by `blade` in the `argv-fuzz` manner as an example: 
```
cd blade/bzip2-1.0.5-argv-fuzz 
```

### Run AFL++
```
bash -x ./afl_auto_test.sh reduced [sanitizer] [start_seed_num] [end_seed_num] [cpu_id]
```
* [sanitizer]: nosan / asan / ubsan / msan / tsan / lsan
* [start_seed_num]: the start index of seeds you want to use
* [end_seed_num]: the end index of seeds you want to use
* [cpu_id]: the index of your available cpu core

For example, if you only want to run AFL++ using seed_2 with the help of memory sanitizer in your 3rd cpu core, you should run: 
```
bash -x ./afl_auto_test.sh reduced msan 2 2 3
```

### Run SymCC
```
bash -x ./symcc_auto_test.sh reduced [start_seed_num] [end_seed_num] [cpu_id]
```
* [start_seed_num]: the start index of seeds you want to use
* [end_seed_num]: the end index of seeds you want to use
* [cpu_id]: the index of your available cpu core

As SymCC does not support sanitizer-guided symbolic execution, you do not have to assign a sanitizer for it.

### Run Radamsa

As Radamsa is only capable of generating the fuzzed inputs, we separated its fuzzed input generation from using it to perfrom fuzz testing.

#### Fuzzed input generation
We retained all the minimized seed corpus in corresponding directory in the `chisel` folder. 

So you should enter the `chisel/xxx/input/radamsa_fuzzed` folder to generate Radamsa-fuzzed inputs.
```
pushd chisel/bzip2-1.0.5-argv-fuzz/input/radamsa_fuzzed
bash create_fuzzed_testfile.sh
popd
```

#### Perform Radamsa-based fuzz testing
As running Radamsa-based fuzz testing is much like the process of validation, we merged this step into the script for the validation step.

You can skip this step, or solely run this step as following: 
```
# in the blade/bzip2-1.0.5-argv-fuzz folder
bash -x ./verify.sh radamsa [sanitizer] save [out_dir]
```
* [sanitizer]: nosan / asan / ubsan / msan / tsan / lsan
* [out_dir]: where you would like to save the output.

## How to validate and deduplicate
We implemented the validation and deduplication phase altogether in `verify.sh`, and wrote an `auto_verify.sh` script to validate and deduplicate all the soundness issues detected by the three fuzzers successively.

You can simply run:
```
bash -x ./auto_verify.sh [out_dir]
```
* [out_dir]: where you would like to save the output.

In our study, we saved all the output (the validated and deduplicated soundness issues) in the [deb-vul-repair](https://github.com/Isabel0715/deb-vul-repair/tree/hpc) repo.
